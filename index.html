<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–¥–∞–∂</title>
    <meta name="theme-color" content="#4e73df">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <!-- PWA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–¥–∞–∂">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–¥–∞–∂">
    
    <!-- iOS splash screen -->
    <link rel="apple-touch-startup-image" href="icon-512.png">
    
    <style>
        /* –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ */
        #app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #4e73df;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 2000;
        }
        #loading-status {
            margin-top: 20px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
    <div id="app-loading">
        –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
        <div id="loading-status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="header">
        <div class="header-container">
            <button id="prev-month">&lt;</button>
            <button id="month-year-selector" class="month-selector">
                <h2 id="current-month-year">–ò—é–ª—å 2025</h2>
            </button>
            <button id="next-month">&gt;</button>
        </div>
        
        <div class="tools-container">
            <button id="palette-btn" class="palette-btn">üé®</button>
            <button id="summary-btn">–†–∞—Å—á–µ—Ç—ã</button>
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–∞–ª–∏—Ç—Ä—ã -->
    <div id="palette-panel" class="palette-panel">
        <div class="palette-tools">
            <div class="palette-tool fill" data-color="#ffffff" style="background-color: #ffffff"></div>
            <div class="palette-tool fill" data-color="#ffcccc" style="background-color: #ffcccc"></div>
            <div class="palette-tool fill" data-color="#ccffcc" style="background-color: #ccffcc"></div>
            <div class="palette-tool fill" data-color="#ccccff" style="background-color: #ccccff"></div>
            <div class="palette-tool fill" data-color="#FFA500" style="background-color: #FFA500"></div>
            <div class="palette-tool fill" data-color="#40E0D0" style="background-color: #40E0D0"></div>
            <div class="palette-tool fill" data-color="#ADFF2F" style="background-color: #ADFF2F"></div>
            <div id="palette-border" class="palette-tool" title="–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±–≤–æ–¥–∫–∞">üî≤</div>
        </div>
    </div>
    
    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div id="calendar" class="calendar"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–î–µ–Ω—å <span id="modal-day"></span></h3>
            <input type="number" id="sales-input" placeholder="–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂" inputmode="numeric">
            <textarea id="comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
            <div class="color-picker">
                <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                <div class="color-option" style="background-color: #ffcccc;" data-color="#ffcccc"></div>
                <div class="color-option" style="background-color: #ccffcc;" data-color="#ccffcc"></div>
                <div class="color-option" style="background-color: #ccccff;" data-color="#ccccff"></div>
                <div class="color-option" style="background-color: #FFA500;" data-color="#FFA500"></div>
                <div class="color-option" style="background-color: #40E0D0;" data-color="#40E0D0"></div>
                <div class="color-option" style="background-color: #ADFF2F;" data-color="#ADFF2F"></div>
            </div>
            <button id="save-data">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="summary-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–†–∞—Å—á–µ—Ç—ã –∑–∞ <span id="summary-month-year">–ò—é–ª—å 2025</span></h3>
            <div class="summary-results">
                <p>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π: <span id="modal-work-days">0</span></p>
                <p>–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂: <span id="modal-total-sales">0</span> —Ä—É–±</p>
                <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="modal-total-earned">0</span> —Ä—É–±</p>
                <p>–ó–∞—Ä–ø–ª–∞—Ç–∞: <span id="modal-salary">0</span> —Ä—É–±</p>
                <p>–û—Å—Ç–∞—Ç–æ–∫: <span id="modal-balance">0</span> —Ä—É–±</p>
            </div>
        </div>
    </div>
    
    <div id="period-modal" class="modal">
        <div class="modal-content period-selector">
            <span class="close">&times;</span>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</h3>
            <div class="period-step" id="year-step">
                <h4>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥</h4>
                <div class="period-options" id="year-options"></div>
            </div>
            <div class="period-step" id="month-step" style="display:none">
                <h4>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</h4>
                <div class="period-options" id="month-options"></div>
            </div>
            <button id="period-back" style="display:none">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
        const SW_VERSION = 'v4';
        const currentSwVersion = localStorage.getItem('sw_version');
        
        if (currentSwVersion !== SW_VERSION) {
            updateLoadingStatus('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞...');
            
            caches.keys().then(cacheNames => {
                const deletePromises = cacheNames.map(cacheName => {
                    return caches.delete(cacheName);
                });
                
                return Promise.all(deletePromises);
            })
            .then(() => {
                localStorage.setItem('sw_version', SW_VERSION);
                updateLoadingStatus('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞:', error);
                localStorage.setItem('sw_version', SW_VERSION);
                updateLoadingStatus('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...');
                setTimeout(() => location.reload(), 1000);
            });
        }
        else {
            // –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            initializeApp();
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initializeApp() {
            updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            function launchFullscreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å –¥–æ–º–∞—à–Ω–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
            function isRunningStandalone() {
                return (window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone ||
                       document.referrer.includes('android-app://'));
            }

            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    updateLoadingStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker...');
                    
                    return navigator.serviceWorker.register('sw.js')
                        .then(reg => {
                            console.log('SW registered');
                            return reg;
                        })
                        .catch(err => {
                            console.error('SW registration error:', err);
                            throw err;
                        });
                }
                return Promise.resolve();
            }

            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            window.addEventListener('DOMContentLoaded', () => {
                updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞...');
                
                registerServiceWorker()
                    .then(() => {
                        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        document.getElementById('app-loading').style.display = 'none';
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è PWA
                        if (isRunningStandalone()) {
                            try {
                                launchFullscreen();
                            } catch (e) {
                                console.log('Fullscreen error:', e);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                        document.getElementById('app-loading').style.display = 'none';
                    });
            });

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∂–µ—Å—Ç–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞
            document.addEventListener('touchmove', function(event) {
                if (event.scale !== 1) {
                    event.preventDefault();
                }
            }, { passive: false });

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            document.addEventListener('contextmenu', event => event.preventDefault());
        }
    </script>
</body>
</html>
